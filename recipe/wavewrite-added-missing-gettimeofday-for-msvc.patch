From a5692b6e7e555ad23706d235f2e4f203563e5352 Mon Sep 17 00:00:00 2001
From: Josh Blum <josh@joshknows.com>
Date: Fri, 4 Dec 2020 09:21:44 -0600
Subject: [PATCH] wavewrite: added missing gettimeofday for msvc

this is the same implementation in rtl_tcp/udp
---
 src/convenience/wavewrite.c | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)

diff --git a/src/convenience/wavewrite.c b/src/convenience/wavewrite.c
index ccd5c36..c73e98d 100644
--- a/src/convenience/wavewrite.c
+++ b/src/convenience/wavewrite.c
@@ -43,6 +43,28 @@ static waveFileHeader waveHdr;
 static uint32_t	waveDataSize = 0;
 int	waveHdrStarted = 0;
 
+#ifdef _WIN32
+int gettimeofday(struct timeval *tv, void* ignored)
+{
+	FILETIME ft;
+	unsigned __int64 tmp = 0;
+	if (NULL != tv) {
+		GetSystemTimeAsFileTime(&ft);
+		tmp |= ft.dwHighDateTime;
+		tmp <<= 32;
+		tmp |= ft.dwLowDateTime;
+		tmp /= 10;
+#ifdef _MSC_VER
+		tmp -= 11644473600000000Ui64;
+#else
+		tmp -= 11644473600000000ULL;
+#endif
+		tv->tv_sec = (long)(tmp / 1000000UL);
+		tv->tv_usec = (long)(tmp % 1000000UL);
+	}
+	return 0;
+}
+#endif
 
 static void waveSetCurrTime(Wind_SystemTime *p)
 {
